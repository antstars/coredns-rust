# CoreDNS-Rust ðŸ¦€ ðŸ›¡ï¸

**CoreDNS-Rust** æ˜¯ä¸€ä¸ªåŸºäºŽ Rust å¼‚æ­¥è¿è¡Œæ—¶ (Tokio) ç¼–å†™çš„é«˜æ€§èƒ½ã€é˜²æ±¡æŸ“ DNS ç½‘å…³ã€‚å®ƒé«˜åº¦å…¼å®¹å®˜æ–¹ CoreDNS çš„ `Corefile` é…ç½®è¯­æ³•ï¼Œä½†åœ¨åº•å±‚ä¸“ä¸º **å¤æ‚çš„ DNS-over-TLS (DoT) çº§è”å®¹ç¾** ã€**æ™ºèƒ½é”™è¯¯æŠ˜å **ä»¥åŠ**0 ä¸¢åŒ…çƒ­é‡è½½**è¿›è¡Œäº†ç¡¬æ ¸é‡æž„ã€‚

é€‚åˆç”¨ä½œä¼ä¸šçº§ DNS åˆ†æµç½‘å…³ã€å®¶åº­é˜²æ±¡æŸ“æ—è·¯ç”± DNSï¼Œæˆ–ä»»ä½•éœ€è¦æžè‡´æ€§èƒ½ä¸Žé«˜å¯ç”¨æ€§çš„ DNS åœºæ™¯ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

* ðŸš€  **çº¯å¼‚æ­¥æž¶æž„** ï¼šåŸºäºŽ `tokio` æž„å»ºï¼Œè½»æ¾åº”å¯¹æžé«˜å¹¶å‘è¯·æ±‚ï¼Œå†…å­˜å ç”¨æžä½Žã€‚
* ðŸ”’  **é‡ç«åŠ› Forward å¼•æ“Ž** ï¼š
  * åŽŸç”Ÿæ”¯æŒ **DNS-over-TLS (DoT)** åŠè‡ªå®šä¹‰ SNI (`tls_servername`)ï¼Œå®Œç¾Žç©¿é€ç½‘ç»œé˜»æ–­ã€‚
  * **é«˜çº§è´Ÿè½½å‡è¡¡** ï¼šæ”¯æŒ `sequential` (ä¸»å¤‡å®¹ç¾)ã€`round_robin` (åŒæ´»è½®è¯¢)ã€`random` ç­–ç•¥ã€‚
  * **ä¸»åŠ¨å¥åº·æ£€æŸ¥ä¸Žç†”æ–­** (`health_check` / `max_fails`)ï¼šæ¯«ç§’çº§å‰”é™¤å®•æœºèŠ‚ç‚¹ï¼Œç»ç”Ÿæ­»ç£•ã€‚
  * **çŠ¶æ€æœºç©¿é€æŽ§åˆ¶** ï¼š`failover` è‡ªåŠ¨é‡è¯• SERVFAILï¼Œ`next` è‡ªåŠ¨ä¸‹æ²‰ NXDOMAIN é˜²æ­¢æ¼ç½‘ä¹‹é±¼ã€‚
  * **è¿žæŽ¥æ± å¤ç”¨** (`max_idle_conns`)ï¼šå¤ç”¨ TLS æ¡æ‰‹é€šé“ï¼Œå¤§å¹…é™ä½Žé«˜é¢‘æŸ¥è¯¢å»¶è¿Ÿã€‚
* ðŸ§   **æ™ºèƒ½é”™è¯¯æŠ˜å  (Errors)** ï¼šé€šè¿‡ Actor æ¨¡åž‹ä¸Žæ­£åˆ™è¡¨è¾¾å¼ï¼Œåœ¨æ—¶é—´çª—å£å†…èšåˆç›¸åŒçš„åº•å±‚ç½‘ç»œé”™è¯¯æ—¥å¿—ï¼ˆå¦‚è¶…æ—¶ï¼‰ï¼Œé˜²æ­¢ç½‘ç»œæŠ–åŠ¨æ—¶çš„æ—¥å¿—é£Žæš´å†™æ»¡ç£ç›˜ã€‚
* âš¡  **æžé€Ÿå†…å­˜ç¼“å­˜ (Cache)** ï¼šæ´‹è‘±æ¨¡åž‹å®žçŽ°çš„ LRU å¹¶å‘å®‰å…¨ç¼“å­˜ï¼Œåˆ†åˆ«ç‹¬ç«‹æŽ§åˆ¶ Success å’Œ Denial (NXDOMAIN/SERVFAIL) çš„ TTLã€‚
* ðŸ”„  **æ— æŸçƒ­é‡è½½ (Graceful Reload)** ï¼šåŽå°æŠ–åŠ¨è½®è¯¢ `Corefile` çš„ SHA512 å“ˆå¸Œï¼Œæ–‡ä»¶å˜æ›´æ—¶çž¬é—´æ— ç¼åˆ‡æ¢ç›‘å¬å™¨å¥æŸ„ï¼Œå®žçŽ° **0 ä¸¢åŒ…ã€0 åœæœº** çƒ­æ›´æ–°ã€‚
* ðŸ“Š  **åŽŸç”Ÿ Prometheus ç›‘æŽ§** ï¼šå†…ç½® `/metrics` ç«¯ç‚¹ï¼Œæä¾› QPSã€ç¼“å­˜å‘½ä¸­çŽ‡ã€ä¸Šæ¸¸ RCODE åˆ†å¸ƒã€é‡è½½çŠ¶æ€ç­‰ä¼ä¸šçº§å¤§ç›˜æŒ‡æ ‡ã€‚

## ðŸ“¦ å¿«é€Ÿå¼€å§‹

### ç¼–è¯‘ä¸Žå®‰è£…

ç¡®ä¿ä½ çš„ç³»ç»Ÿå·²å®‰è£… [Rust å·¥å…·é“¾](https://rustup.rs/)ï¼š

**Bash**

```
# å…‹éš†ä»“åº“
git clone https://github.com/yourusername/coredns-rust.git
cd coredns-rust

# ç¼–è¯‘ Release ç‰ˆæœ¬
cargo build --release

# è¿è¡ŒæœåŠ¡å™¨
./target/release/coredns-rust --config Corefile
```

## ðŸ› ï¸ é…ç½®ç¤ºä¾‹ (Corefile)

CoreDNS-Rust å…¼å®¹æ ‡å‡†çš„ `Corefile` è¯­æ³•ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…¸åž‹çš„**å›½å†…å¤–åˆ†æµ + é«˜å¯ç”¨é˜²æ±¡æŸ“**é…ç½®æ–¹æ¡ˆï¼š

**Plaintext**

```
# å›½å†…è§£æžç»„ (UDP)
.:1053 {
    log
    cache 3600
    prometheus 0.0.0.0:9153
    errors {
        # å°† 30 ç§’å†…çš„è¶…æ—¶æŠ¥é”™æŠ˜å ä¸ºä¸€æ¡è­¦å‘Š
        consolidate 30s "^Failed to .+" warning
    }
  
    # å›½å†…å¤šçº§å®¹ç¾ï¼ˆé¡ºåºç­–ç•¥ï¼‰
    forward . 119.29.29.29 223.5.5.5 114.114.114.114 {
        policy sequential
        health_check 1s
        max_fails 3
    }
}

# æµ·å¤–è§£æžç»„ (åŠ å¯† DoT + é˜²æ¼æŠ¥ç©¿é€)
.:1054 {
    log
    cache {
        success 10000 3600
        denial 5000 1800
    }
  
    # ç¬¬ä¸€æ¢¯é˜Ÿï¼šGoogle DNS (è½®è¯¢è´Ÿè½½å‡è¡¡)
    forward . tls://8.8.8.8 tls://8.8.4.4 {
        tls_servername dns.google
        policy round_robin
        max_idle_conns 1000
        health_check 0.5s
        max_fails 2
        failover SERVFAIL REFUSED
        next NXDOMAIN  # å¦‚æžœ Google è¿”å›žä¸å­˜åœ¨ï¼Œä¸¢ç»™ä¸‹ä¸€æ¢¯é˜Ÿç»§ç»­æŸ¥ï¼
    }
  
    # ç¬¬äºŒæ¢¯é˜Ÿï¼šCloudflare (å…œåº•)
    forward . tls://1.1.1.1 tls://1.0.0.1 {
        tls_servername cloudflare-dns.com
        policy round_robin
    }
}

# å…¨å±€åŽå°ç»„ä»¶
. {
    # æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡é…ç½®æ–‡ä»¶å˜æ›´ï¼Œå¹¶æ·»åŠ  5 ç§’éšæœºæŠ–åŠ¨é˜²æ­¢é›†ç¾¤å¹¶å‘é‡å¯é£Žæš´
    reload 10s 5s
    health :8100
}
```

## ðŸ§© å·²æ”¯æŒçš„æ’ä»¶åˆ—è¡¨

ç›®å‰é¡¹ç›®ä¸­é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ¯ä¸ªæ’ä»¶ç‹¬ç«‹è§£è€¦ï¼Œå·²å®žçŽ°ä»¥ä¸‹æ ¸å¿ƒæ’ä»¶ï¼š

| **æ’ä»¶åç§°** | **çŠ¶æ€** | **æè¿°**                                     |
| ------------------ | -------------- | -------------------------------------------------- |
| `forward`        | ðŸŸ¢ æ ¸å¿ƒ        | é«˜çº§è½¬å‘å¼•æ“Ž (DoT, å¹¶å‘æŽ§åˆ¶, ç†”æ–­, è¿žæŽ¥æ± , Policy) |
| `cache`          | ðŸŸ¢ æ ¸å¿ƒ        | é«˜æ€§èƒ½è¯»å†™é”ç¼“å­˜ (åŸºäºŽæ´‹è‘±æ¨¡åž‹æ‹¦æˆª)                |
| `errors`         | ðŸŸ¢ æ ¸å¿ƒ        | å¼‚æ­¥æ­£åˆ™èšåˆæ—¥å¿—ç®¡ç†å™¨ (Consolidate)               |
| `reload`         | ðŸŸ¢ æ ¸å¿ƒ        | SHA512 æ–‡ä»¶ç³»ç»Ÿç›‘æŽ§ä¸Žçƒ­é‡è½½ (Graceful Restart)     |
| `prometheus`     | ðŸŸ¢ æ ¸å¿ƒ        | æ ‡å‡†çš„ Metrics ç›‘æŽ§ç«¯ç‚¹æš´éœ²                        |
| `whoami`         | ðŸŸ¢ åŸºç¡€        | å›žæ˜¾å®¢æˆ·ç«¯ IP å’Œç«¯å£ (çº¯å­—èŠ‚æµæž„å»º)                |
| `health`         | ðŸŸ¢ åŸºç¡€        | å¥åº·æ£€æŸ¥ç«¯ç‚¹ (`/health`readiness probe)          |
| `log`            | ðŸŸ¢ åŸºç¡€        | æ ‡å‡†æŸ¥è¯¢è®¿é—®æ—¥å¿—è®°å½•                               |

## ðŸ“ˆ ç›‘æŽ§å¤§ç›˜

é…ç½® `prometheus` æ’ä»¶åŽï¼Œå¯ä½¿ç”¨ Prometheus Server æŠ“å– `http://127.0.0.1:9153/metrics`ã€‚

æ”¯æŒçš„æŸ¥è¯¢ç»´åº¦ç¤ºä¾‹ï¼š

* ç¼“å­˜å‘½ä¸­çŽ‡ï¼š`coredns_cache_hits_total{type="success"}`
* ä¸Šæ¸¸èŠ‚ç‚¹è¶…æ—¶é¢‘çŽ‡ï¼š`coredns_forward_responses_total{rcode="SERVFAIL"}`
* åŠ¨æ€é‡è½½çŠ¶æ€ï¼š`coredns_reload_version_info`

## ðŸ¤ è´¡çŒ®ä¸Žå¼€å‘

æ¬¢è¿Žæäº¤ Issue å’Œ Pull Requestï¼

å¦‚æžœè¦æ‰©å±•æ–°æ’ä»¶ï¼Œåªéœ€åœ¨ `src/plugin/` ç›®å½•ä¸‹æ–°å»ºæ¨¡å—ï¼Œå®žçŽ° `Plugin` trait çš„ `process` (åŽ»ç¨‹æ‹¦æˆª) å’Œ `post_process` (å›žç¨‹ç¼“å­˜) æ–¹æ³•ï¼Œå¹¶åœ¨ `mod.rs` ä¸­æ³¨å†Œå³å¯ã€‚

## ðŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäºŽ [MIT License](https://www.google.com/search?q=LICENSE&authuser=2) è®¸å¯å¼€æºã€‚

---

*â€œç”¨æœ€å®‰å…¨çš„è¯­è¨€ï¼Œå†™æœ€ç¡¬æ ¸çš„ç½‘å…³ã€‚â€* ðŸš€
=======================================

# coredns-rust

CoreDNS-Rust is a high-performance, pollution-resistant DNS gateway built on Rust's asynchronous runtime (Tokio).

>>>>>>> dcadc94278999e281da29cdded7b6e1bdd52d240
>>>>>>>
>>>>>>
>>>>>
>>>>
>>>
>>
